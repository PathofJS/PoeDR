<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoE Damage Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            margin: auto;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 15px;
            flex-basis: 100%;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .input-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        /* Style for read-only range input (the calculated PDR display) */
        .input-group input[type="range"][readonly] {
            background: #e0e0e0;
            cursor: default;
        }
        .input-group input[type="range"][readonly]::-webkit-slider-thumb {
            background: #888;
            cursor: default;
        }

        .input-group input[type="number"] {
            width: calc(100% - 12px);
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .output-group {
            margin-top: 30px;
            padding: 15px;
            background-color: #e9ffe9;
            border: 1px solid #c9f0c9;
            border-radius: 8px;
            text-align: center;
            clear: both;
            width: 100%;
            box-sizing: border-box;
        }
        .output-group strong {
            font-size: 1.5em;
            color: #28a745;
        }
        .section-header {
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        /* Flexbox styling for paired inputs (2 per row) */
        .elemental-pair,
        .physical-pair {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 15px;
            /* Shading and padding for segmentation */
            background-color: #eeeeee; /* Slightly darker gray background */
            padding: 15px;
            border-radius: 5px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }
        .elemental-pair .input-group,
        .physical-pair .input-group {
            margin-bottom: 0;
            flex-basis: calc(50% - 10px);
        }


        /* New Flexbox styling for 3 inputs in a row */
        .three-column-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 15px;
            /* Shading and padding for segmentation */
            background-color: #eeeeee; /* Slightly darker gray background */
            padding: 15px;
            border-radius: 5px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }
        .three-column-row .input-group {
            margin-bottom: 0;
            flex-basis: calc((100% - 40px) / 3);
        }
        .three-column-row .input-group input[type="number"],
        .three-column-row .input-group input[type="range"] {
            width: calc(100% - 20px);
        }

        /* Adjust width for number inputs inside the flex items that have 2 columns */
        .elemental-pair .input-group input[type="number"],
        .physical-pair .input-group input[type="number"] {
            width: calc(100% - 20px);
        }

        /* Additional output for Armour's dynamic PDR */
        #armourPDRDisplay {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Path of Exile Physical Damage Reduction Calculator</h1>

        <div class="section-header">Incoming Damage & Physical Mitigation</div>

        <div class="input-group">
            <label for="incomingPhysDamage">Incoming Physical Damage:</label>
            <input type="number" id="incomingPhysDamage" min="0" value="1000">
        </div>

        <div class="physical-pair">
            <div class="input-group">
                <label for="armour">Armour:</label>
                <input type="number" id="armour" min="0" value="0">
                <div id="armourPDRDisplay"></div>
            </div>
            <div class="input-group">
                <label for="totalPhysDR">Total Physical DR (%): <span id="totalPhysDRValue">0</span>%</label>
                <input type="range" id="totalPhysDR" min="0" max="90" value="0" readonly>
            </div>
        </div>

        <div class="three-column-row">
            <div class="input-group">
                <label for="otherPhysDR">% Additional Physical Damage Reduction:</label>
                <input type="number" id="otherPhysDR" min="0" max="90" value="0">
            </div>

            <div class="input-group">
                <label for="enduranceCharges">Endurance Charges: <span id="enduranceChargesValue">0</span></label>
                <input type="range" id="enduranceCharges" min="0" max="12" value="0">
            </div>

            <div class="input-group">
                <label for="flatPhysTaken">Flat Physical Taken:</label>
                <input type="number" id="flatPhysTaken" min="0" value="0">
            </div>
        </div>


        <div class="section-header">Elemental Damage Conversion & Resistances</div>

        <div class="elemental-pair">
            <div class="input-group">
                <label for="physTakenFire">% of Physical Damage from Hits taken as Fire Damage:</label>
                <input type="number" id="physTakenFire" min="0" max="100" value="0">
            </div>
            <div class="input-group">
                <label for="fireResist">Fire Resistance (%): <span id="fireResistValue">75</span>%</label>
                <input type="range" id="fireResist" min="0" max="90" value="75">
            </div>
        </div>

        <div class="elemental-pair">
            <div class="input-group">
                <label for="physTakenCold">% of Physical Damage from Hits taken as Cold Damage:</label>
                <input type="number" id="physTakenCold" min="0" max="100" value="0">
            </div>
            <div class="input-group">
                <label for="coldResist">Cold Resistance (%): <span id="coldResistValue">75</span>%</label>
                <input type="range" id="coldResist" min="0" max="90" value="75">
            </div>
        </div>

        <div class="elemental-pair">
            <div class="input-group">
                <label for="physTakenLightning">% of Physical Damage from Hits taken as Lightning Damage:</label>
                <input type="number" id="physTakenLightning" min="0" max="100" value="0">
            </div>
            <div class="input-group">
                <label for="lightningResist">Lightning Resistance (%): <span id="lightningResistValue">75</span>%</label>
                <input type="range" id="lightningResist" min="0" max="90" value="75">
            </div>
        </div>


        <div class="output-group">
            <p>Final Damage Received: <strong id="finalDamage">0</strong></p>
            <p> (Breakdown: <span id="finalPhysDmg">0</span> Physical, <span id="finalFireDmg">0</span> Fire, <span id="finalColdDmg">0</span> Cold, <span id="finalLightningDmg">0</span> Lightning)</p>
        </div>
    </div>

    <script>
        const totalPhysDRDisplayInput = document.getElementById('totalPhysDR');
        const totalPhysDRValueSpan = document.getElementById('totalPhysDRValue');
        const incomingPhysDamageInput = document.getElementById('incomingPhysDamage');
        const enduranceChargesInput = document.getElementById('enduranceCharges');
        const enduranceChargesValueSpan = document.getElementById('enduranceChargesValue');
        const flatPhysTakenInput = document.getElementById('flatPhysTaken');
        const physTakenFireInput = document.getElementById('physTakenFire');
        const physTakenColdInput = document.getElementById('physTakenCold');
        const physTakenLightningInput = document.getElementById('physTakenLightning');
        const otherPhysDRInput = document.getElementById('otherPhysDR');
        const fireResistInput = document.getElementById('fireResist');
        const fireResistValueSpan = document.getElementById('fireResistValue');
        const coldResistInput = document.getElementById('coldResist');
        const coldResistValueSpan = document.getElementById('coldResistValue');
        const lightningResistInput = document.getElementById('lightningResist');
        const lightningResistValueSpan = document.getElementById('lightningResistValue');
        const armourInput = document.getElementById('armour');
        const armourPDRDisplay = document.getElementById('armourPDRDisplay');
        const finalDamageOutput = document.getElementById('finalDamage');
        const finalPhysDmgSpan = document.getElementById('finalPhysDmg');
        const finalFireDmgSpan = document.getElementById('finalFireDmg');
        const finalColdDmgSpan = document.getElementById('finalColdDmg');
        const finalLightningDmgSpan = document.getElementById('finalLightningDmg');


        function calculateDamage() {
            let incomingDamage = parseFloat(incomingPhysDamageInput.value) || 0;
            let enduranceCharges = parseInt(enduranceChargesInput.value) || 0;
            let flatPhysTaken = parseFloat(flatPhysTakenInput.value) || 0;
            let physTakenFire = parseFloat(physTakenFireInput.value) || 0;
            let physTakenCold = parseFloat(physTakenColdInput.value) || 0;
            let physTakenLightning = parseFloat(physTakenLightningInput.value) || 0;
            let armour = parseFloat(armourInput.value) || 0;
            let otherPhysDR = parseFloat(otherPhysDRInput.value) || 0;
            let fireResist = parseFloat(fireResistInput.value) || 0;
            let coldResist = parseFloat(coldResistInput.value) || 0;
            let lightningResist = parseFloat(lightningResistInput.value) || 0;

            enduranceChargesValueSpan.textContent = enduranceCharges;
            fireResistValueSpan.textContent = fireResist;
            coldResistValueSpan.textContent = coldResist;
            lightningResistValueSpan.textContent = lightningResist;

            let damageConvertedToFire = incomingDamage * (physTakenFire / 100);
            let damageConvertedToCold = incomingDamage * (physTakenCold / 100);
            let damageConvertedToLightning = incomingDamage * (physTakenLightning / 100);

            let rawPhysicalDamageAfterConversion = Math.max(0, incomingDamage - (damageConvertedToFire + damageConvertedToCold + damageConvertedToLightning));

            let armourPDR = 0;
            if (rawPhysicalDamageAfterConversion > 0 && armour > 0) {
                armourPDR = (armour / (armour + (10 * rawPhysicalDamageAfterConversion))) * 100;
                armourPDR = Math.min(90, armourPDR);
            }
            armourPDRDisplay.textContent = `PDR from Armour: ${armourPDR.toFixed(2)}% (against ${rawPhysicalDamageAfterConversion.toFixed(0)} phys)`;

            let endurancePhysDR = enduranceCharges * 4;
            let combinedPhysicalDR = armourPDR + endurancePhysDR + otherPhysDR;
            combinedPhysicalDR = Math.min(90, combinedPhysicalDR);

            totalPhysDRDisplayInput.value = combinedPhysicalDR;
            totalPhysDRValueSpan.textContent = combinedPhysicalDR.toFixed(2);

            let effectivePhysicalDamage = rawPhysicalDamageAfterConversion * (1 - (combinedPhysicalDR / 100));
            effectivePhysicalDamage = Math.max(0, effectivePhysicalDamage - flatPhysTaken);

            let mitigatedFireDamage = damageConvertedToFire * (1 - (fireResist / 100));
            let mitigatedColdDamage = damageConvertedToCold * (1 - (coldResist / 100));
            let mitigatedLightningDamage = damageConvertedToLightning * (1 - (lightningResist / 100));

            let enduranceEleDRFactor = (1 - (enduranceCharges * 0.04));
            enduranceEleDRFactor = Math.max(0, enduranceEleDRFactor);

            mitigatedFireDamage *= enduranceEleDRFactor;
            mitigatedColdDamage *= enduranceEleDRFactor;
            mitigatedLightningDamage *= enduranceEleDRFactor;

            let finalDamage = effectivePhysicalDamage + mitigatedFireDamage + mitigatedColdDamage + mitigatedLightningDamage;

            finalDamageOutput.textContent = finalDamage.toFixed(2);
            finalPhysDmgSpan.textContent = effectivePhysicalDamage.toFixed(2);
            finalFireDmgSpan.textContent = mitigatedFireDamage.toFixed(2);
            finalColdDmgSpan.textContent = mitigatedColdDamage.toFixed(2);
            finalLightningDmgSpan.textContent = mitigatedLightningDamage.toFixed(2);
        }

        incomingPhysDamageInput.addEventListener('input', calculateDamage);
        enduranceChargesInput.addEventListener('input', calculateDamage);
        flatPhysTakenInput.addEventListener('input', calculateDamage);
        physTakenFireInput.addEventListener('input', calculateDamage);
        physTakenColdInput.addEventListener('input', calculateDamage);
        physTakenLightningInput.addEventListener('input', calculateDamage);
        armourInput.addEventListener('input', calculateDamage);
        otherPhysDRInput.addEventListener('input', calculateDamage);
        fireResistInput.addEventListener('input', calculateDamage);
        coldResistInput.addEventListener('input', calculateDamage);
        lightningResistInput.addEventListener('input', calculateDamage);

        calculateDamage();
    </script>
</body>
</html>